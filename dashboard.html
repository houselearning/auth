<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CoolMathTime - Learning Dashboard</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* ====================================================================== */
        /* KHAN ACADEMY STYLE VARIABLES & RESET (BASE STYLES) */
        /* ====================================================================== */
        :root {
            --primary-color: #142838; /* KA Blue Dark */
            --primary-hover-color: #1a3a55;
            --accent-color: #14a4cc; /* KA Blue Bright */
            --background-color: #f7f7f7; /* KA Gray Light */
            --text-color-dark: #2e333b;
            --text-color-light: #5e646f;
            --success-color: #008064; /* KA Accent Green */
            --danger-color: #dc3545; /* KA Red Error */
            --border-color: #e6e6e6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color-dark);
        }

        #app-header {
            background-color: white;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.8em;
            margin: 0;
            color: var(--primary-color);
        }

        .logout-button {
            background-color: var(--danger-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .role-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            font-size: 0.9em;
            color: var(--text-color-light);
        }

        .role-switch .active-role {
            font-weight: bold;
            color: var(--primary-color);
        }

        .role-switch button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        #dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px 20px;
        }

        .section-title {
            color: var(--text-color-dark);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            margin: 25px 0 15px 0;
            font-size: 1.4em;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .feature-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        /* Neutral look for all cards (removed highlight-progress border) */
        .feature-card .icon {
            font-size: 1.5em;
            margin-right: 10px;
            color: var(--primary-color);
        }

        .feature-card .card-header {
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .feature-card .card-meta {
            font-size: 0.9em;
            color: var(--text-color-light);
            margin-top: 5px;
            padding-left: 30px; /* Align meta text under the header text */
        }
        
        /* Class Card Specific Styles (for Teacher/Student view of classes) */
        .class-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border-left: 5px solid var(--accent-color); /* Light blue border */
        }

        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .class-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .class-card h3 {
            margin: 0;
            font-size: 1.2em;
            color: var(--text-color-dark);
        }

        .class-card p {
            margin: 3px 0;
            font-size: 0.9em;
            color: var(--text-color-light);
        }

        .class-permissions {
            margin-top: 10px;
            font-size: 0.8em;
            display: flex;
            gap: 15px;
        }

        .settings-button {
            background: none;
            border: none;
            color: var(--text-color-light);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.1s;
        }

        .settings-button:hover {
            background-color: var(--border-color);
        }

        .create-class-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 2px dashed var(--border-color);
            color: var(--text-color-light);
            font-weight: bold;
            min-height: 150px;
        }

        .create-class-card:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .create-class-card .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* Assignment Styles (Demo) */
        .assignment-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .assignment-card {
            border-left: 5px solid var(--accent-color);
        }

        .assignment-card.overdue {
            border-left: 5px solid var(--danger-color);
        }

        .assignment-card.completed {
            border-left: 5px solid var(--success-color);
        }

        /* Join Class Section */
        .join-class-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .join-class-container input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .join-class-container button {
            background-color: var(--success-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .loading-message, .empty-state-message, .info-message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .loading-message {
            background-color: #e9f5ff;
            color: var(--primary-color);
        }

        .empty-state-message {
            background-color: #e6fff2;
            color: var(--success-color);
        }

        .info-message {
            background-color: #fff3cd;
            color: #856404;
        }

        /* Modal Base Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 5% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .modal-content h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .modal-content label, .modal-content input, .modal-content select {
            display: block;
            width: 100%;
            margin-bottom: 15px;
        }

        .modal-content input[type="text"], .modal-content input[type="url"], .modal-content input[type="password"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            margin-top: 15px;
        }

        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .save-button {
            background-color: var(--success-color);
            color: white;
        }

        .cancel-button {
            background-color: #f0f0f0;
            color: var(--text-color-dark);
        }

        .delete-button {
            background-color: var(--danger-color);
            color: white;
            margin-right: auto; /* Push to the left in the footer */
        }
        
        .toggle-switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .toggle-switch-container span {
            font-weight: normal;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 25px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-color-light);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 3.5px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(18px);
        }

        /* Confirmation Dialog (Modal 4) */
        .confirm-modal .modal-content {
            border-top: 5px solid var(--danger-color);
        }

        .confirm-modal .modal-footer .confirm-danger-button {
            background-color: var(--danger-color);
            color: white;
        }

        .confirm-modal .modal-footer .cancel-button {
            background-color: #f0f0f0;
            color: var(--text-color-dark);
        }
        
        /* ====================================================================== */
        /* CLASS DASHBOARD STYLES (NEW) */
        /* ====================================================================== */

        .class-view-container {
            padding: 0px; /* Removed padding to let the banner use full width */
        }

        .class-dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .class-dashboard-header .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .class-dashboard-header .back-button .material-icons {
            font-size: 1.2em;
        }

        .class-dashboard-header h1 {
            margin: 0;
            font-size: 1.5em;
            flex-grow: 1; 
            text-align: center;
            color: white; /* Override default h1 color */
        }

        .class-dashboard-header .logout-button {
            background-color: var(--accent-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .class-banner {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
            border-radius: 0 0 8px 8px; /* Rounded bottom corners */
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .class-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 50%); 
            z-index: 1;
        }

        .class-banner-content {
            position: relative;
            z-index: 2;
            padding: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .class-banner-settings {
            font-size: 1.5em;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            padding: 5px;
            transition: background-color 0.2s;
        }

        .class-banner-settings:hover {
            background: rgba(255,255,255,0.4);
        }

        .class-banner .class-info h2 {
            margin: 0;
            font-size: 2em;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .class-banner .class-info p {
            margin: 5px 0 0;
            font-size: 1em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }


        /* Post Creation Area */
        .post-creation-area {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin: 0 20px 20px 20px; /* Add horizontal padding for content */
        }

        .post-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .post-input-row input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1em;
        }

        .post-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; 
        }

        .post-options .option-button {
            background-color: #f0f2f5;
            color: #555;
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .post-options .option-button:hover {
            background-color: #e0e2e5;
        }

        .post-options .option-button .material-icons {
            font-size: 1.2em;
        }

        /* Previous Posts Section */
        .previous-posts-section {
            display: grid;
            gap: 15px;
            padding: 0 20px 20px 20px; /* Add horizontal padding for content */
        }

        .post-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .post-item .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .post-item .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #eee;
        }

        .post-item .post-meta {
            flex-grow: 1;
        }

        .post-item .author-name {
            font-weight: bold;
            color: var(--text-color-dark);
        }

        .post-item .post-time {
            font-size: 0.8em;
            color: var(--text-color-light);
            display: block; 
        }

        .post-item .report-button {
            background: none;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            cursor: pointer;
        }

        .post-item .post-body p {
            margin: 0 0 10px 0;
            line-height: 1.5;
        }

        .post-item .posted-image {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            margin-top: 10px;
        }

        .post-item .post-actions {
            margin-top: 10px;
            text-align: right; 
        }

        .post-item .reply-button {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .post-item .reply-button:hover {
            background-color: var(--primary-hover-color);
        }

        /* General button styles for consistency */
        .primary-button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        .primary-button:hover {
            background-color: var(--primary-hover-color);
        }

    </style>
</head>
<body>
    
    <iframe id="hidden-iframe" name="hidden-iframe" style="display: none;"></iframe>

    <header id="app-header">
        <div class="header-controls">
            <h1>CoolMathTime Dashboard</h1>
            <button id="logout-btn" class="logout-button">Sign Out</button>
        </div>
    </header>

    <main id="dashboard-container">
        <div class="loading-message">Loading dashboard...</div>
    </main>

    <div id="class-management-modal" class="modal">
        <div class="modal-content">
            <h2>Create New Class</h2>
            <form id="create-class-form" target="hidden-iframe" method="POST" action="PASTE_YOUR_APPS_SCRIPT_URL_HERE">
                <input type="hidden" name="action" value="createClass">

                <label for="new-class-name">Class Name:</label>
                <input type="text" id="new-class-name" name="name" required>

                <label for="new-class-teacher-id">Teacher ID (Current User):</label>
                <input type="text" id="new-class-teacher-id" name="teacher" readonly required>

                <label for="new-class-code">Class Code (Auto-Generated):</label>
                <input type="text" id="new-class-code" name="code" readonly required>
                
                <div class="toggle-switch-container">
                    <span>Allow Students to Post on Feed:</span>
                    <label class="switch">
                        <input type="checkbox" id="new-class-allow-posting" name="allowPosting" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="toggle-switch-container">
                    <span>Allow Students to Comment on Posts:</span>
                    <label class="switch">
                        <input type="checkbox" id="new-class-allow-commenting" name="allowCommenting" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="modal-footer">
                    <button type="button" class="cancel-button" id="cancel-create-btn">Cancel</button>
                    <button type="submit" class="save-button">Create Class</button>
                </div>
            </form>
        </div>
    </div>

    <div id="class-settings-modal" class="modal">
        <div class="modal-content">
            <h2 id="settings-modal-title">Class Settings</h2>
            <form id="update-class-form" target="hidden-iframe" method="POST" action="PASTE_YOUR_APPS_SCRIPT_URL_HERE">
                <input type="hidden" name="action" value="updateClass">
                <input type="hidden" name="code" id="settings-class-code">

                <label for="settings-class-name">Class Name:</label>
                <input type="text" id="settings-class-name" name="name" required>

                <div class="toggle-switch-container">
                    <span>Allow Students to Post on Feed:</span>
                    <label class="switch">
                        <input type="checkbox" id="settings-allow-posting" name="allowPosting">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="toggle-switch-container">
                    <span>Allow Students to Comment on Posts:</span>
                    <label class="switch">
                        <input type="checkbox" id="settings-allow-commenting" name="allowCommenting">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="modal-footer">
                    <button type="button" class="delete-button" id="delete-class-btn" data-class-code="" data-class-name="">
                        🗑️ Delete Class
                    </button>
                    <button type="button" class="cancel-button" id="cancel-settings-btn">Cancel</button>
                    <button type="button" class="save-button" id="save-settings-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="info-dialog-modal" class="modal">
        <div class="modal-content">
            <h2 id="info-dialog-title"></h2>
            <p id="info-dialog-body"></p>
            <div class="modal-footer">
                <button class="cancel-button" onclick="document.getElementById('info-dialog-modal').style.display='none'">OK</button>
            </div>
        </div>
    </div>

    <div id="confirm-dialog-modal" class="modal confirm-modal">
        <div class="modal-content">
            <h2 id="confirm-dialog-title">Delete Class</h2>
            <p id="confirm-dialog-body">Are you sure you want to delete this class? All data will be lost permanently.</p>
            <div class="modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('confirm-dialog-modal').style.display='none'">Cancel</button>
                <button type="button" class="confirm-danger-button" id="confirm-delete-btn">Yes, Delete Permanently</button>
            </div>
        </div>
    </div>

    <!-- Role Switch Modal (previously referenced but missing) -->
    <div id="role-switch-modal" class="modal">
        <div class="modal-content">
            <h2>Switch Role</h2>
            <p>Select how you want to view the dashboard:</p>
            <div class="modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('role-switch-modal').style.display='none'">Cancel</button>
                <button type="button" class="save-button" onclick="switchRole('student')">View as Student</button>
                <button type="button" class="save-button" onclick="switchRole('teacher')">View as Teacher</button>
            </div>
        </div>
    </div>

    <!-- Join Class Modal (previously referenced but missing) -->
    <div id="join-class-modal" class="modal">
        <div class="modal-content">
            <h2>Join a Class</h2>
            <p>Enter the class code to join.</p>
            <label for="join-class-code">Class Code:</label>
            <input type="text" id="join-class-code" name="joinClassCode" style="width:100%; padding:8px; margin-bottom:10px;" />
            <div class="modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('join-class-modal').style.display='none'">Cancel</button>
                <button type="button" class="save-button" onclick="(function(){ const code=document.getElementById('join-class-code').value.trim(); if(!code){ showInfoDialog('Error','Please enter a valid class code.','error'); return; } document.getElementById('join-class-modal').style.display='none'; /* Placeholder: call Apps Script / API to join */ showInfoDialog('Joined','Requested to join class '+code,'success'); })()">Join Class</button>
            </div>
        </div>
    </div>


    <script>
    // ======================================================================
    // 1. CONFIGURATION & GLOBAL VARIABLES
    // ======================================================================
    
    // 🚨 CRITICAL: REPLACE THIS WITH THE URL from your LATEST Apps Script deployment
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzn_xqn6L8Mkvomk_6sRslAVZecz9_ZTlH2pi5N4Y2cgML3huCV1ogGIXr3QfsTtoLunw/exec'; 

    // 🚨 CRITICAL: REPLACE WITH YOUR FIREBASE CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyDoXSwni65CuY1_32ZE8B1nwfQO_3VNpTw",
      authDomain: "contract-center-llc-10.firebaseapp.com",
      projectId: "contract-center-llc-10",
      storageBucket: "contract-center-llc-10.firebasestorage.app",
      messagingSenderId: "323221512767",
      appId: "1:323221512767:web:6421260f875997dbf64e8a",
    };

    // Initialize Firebase (keep this as-is)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    // const db = firebase.firestore(); // Not used to avoid Firestore constraint

    let currentUserId = null;
    let userRole = 'student'; // Default role
    let userFullName = 'User Name Placeholder'; // Must be fetched/set on login for posts
    
    let currentClassCode = null; 
    let currentClassName = null; 

    // Base64 Storage Constraint
    const MAX_FILE_SIZE_BYTES = 30 * 1024; // 30 KB Limit enforced for Sheet cell storage

    // ======================================================================
    // 2. CORE UTILITIES & HELPERS (JSONP, DIALOGS, AUTH)
    // ======================================================================

    let jsonpCallbackCounter = 0;

    /**
     * Generic function to make a JSONP call to Google Apps Script.
     */
    function fetchJsonp(action, params = {}) {
        return new Promise((resolve, reject) => {
            const callbackName = 'jsonp_callback_' + (jsonpCallbackCounter++);
            
            const queryParams = new URLSearchParams({ 
                action: action, 
                callback: callbackName, 
                ...params 
            }).toString();
            
            const url = SCRIPT_URL + '?' + queryParams;
            
            window[callbackName] = (data) => {
                delete window[callbackName];
                script.remove();
                resolve(data);
            };

            const script = document.createElement('script');
            script.src = url;
            script.onerror = () => {
                delete window[callbackName];
                script.remove();
                reject(new Error('JSONP request failed or Apps Script URL is incorrect.'));
            };
            document.head.appendChild(script);
        });
    }

    /**
     * Handles responses from the hidden iframe after POST submissions.
     */
    window.handlePostResponse = function(result) {
        if (result.status === 'success') {
            showInfoDialog('Success', result.message, 'success');
            // Reload teacher classes if a class was created/deleted/updated
            if (result.message.includes('Class') && currentUserId) {
                if (userRole === 'teacher') loadTeacherData(currentUserId);
                // Class update/delete might affect the current dashboard, reload if necessary
                if (result.message.includes('deleted')) {
                    renderDashboard(userRole);
                }
            }
        } else {
            showInfoDialog('Error', result.message, 'error');
        }
    };

    /**
     * Displays a custom modal dialog.
     */
    function showInfoDialog(title, message, type) {
        const modal = document.getElementById('info-dialog-modal');
        // CRITICAL: Stop execution if the main element is missing
        if (!modal) {
            console.error("CRITICAL ERROR: Modal 'info-dialog-modal' not found in HTML.");
            return; 
        }

        const content = modal.querySelector('.modal-content');
        const titleElement = document.getElementById('info-dialog-title');
        const bodyElement = document.getElementById('info-dialog-body');

        if (titleElement) titleElement.innerText = title;
        if (bodyElement) bodyElement.innerText = message;
        
        let borderColor = 'var(--accent-color)'; 
        if (type === 'error') {
            borderColor = 'var(--danger-color)'; 
        } else if (type === 'success') {
            borderColor = 'var(--success-color)';
        }

        // Apply style safely
        if (content) {
            content.style.borderTop = `5px solid ${borderColor}`;
        }
        
        modal.style.display = 'flex';
    }

    /**
     * Generates a random 6-character alphanumeric code.
     */
    function generateClassCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    /**
     * Fetches the real student enrollment count using JSONP.
     */
    async function getStudentEnrollmentCount() {
        try {
            const result = await fetchJsonp('loadStudentEnrollmentCount', { 
                studentId: currentUserId 
            });
            if (result.status === 'success') {
                return result.count;
            }
        } catch (error) {
            console.error("Error fetching enrollment count:", error);
        }
        return 0; 
    }

    // ======================================================================
    // 3. CLASS MANAGEMENT ACTIONS & MODAL OPENERS
    // ======================================================================

    /**
     * Opens the Class Settings modal. Must be global because it's called via inline 'onclick'.
     */
    window.openClassSettingsModal = function(code, name, allowPosting, allowCommenting) {
        const modal = document.getElementById('class-settings-modal');
        const deleteBtn = document.getElementById('delete-class-btn');
        const titleElement = document.getElementById('settings-modal-title');
        
        // CRITICAL: Stop execution if the main element is missing
        if (!modal) {
            console.error("CRITICAL ERROR: Modal 'class-settings-modal' not found in HTML.");
            return; 
        }

        // Safely set element values/properties (using null check if not critical)
        const codeInput = document.getElementById('settings-class-code');
        const nameInput = document.getElementById('settings-class-name');
        const postCheck = document.getElementById('settings-allow-posting');
        const commentCheck = document.getElementById('settings-allow-commenting');

        if (codeInput) codeInput.value = code;
        if (nameInput) nameInput.value = name;
        if (postCheck) postCheck.checked = allowPosting;
        if (commentCheck) commentCheck.checked = allowCommenting;
        
        if (titleElement) titleElement.innerText = `Settings for ${name}`;
        if (deleteBtn) {
            deleteBtn.dataset.classCode = code;
            deleteBtn.dataset.className = name;
        }
        
        modal.style.display = 'flex';
    };


    /**
     * Submits class creation form.
     */
    function createClass() {
        const form = document.getElementById('create-class-form');
        document.getElementById('new-class-code').value = generateClassCode();
        // Assuming the 'teacher' field in the form uses the user's full name for lookup in Apps Script
        document.getElementById('new-class-teacher-id').value = userFullName; 
        
        form.submit();
    }

    /**
     * Submits class settings update form.
     */
    function saveClassSettings(code, name, allowPosting, allowCommenting) {
        const form = document.getElementById('update-class-form');
        
        // Use correct IDs for code and name fields
        document.getElementById('settings-class-code').value = code;
        document.getElementById('settings-class-name').value = name;
        
        // Dynamically create hidden inputs for boolean submission
        const postInput = document.createElement('input');
        postInput.type = 'hidden';
        postInput.name = 'allowPosting';
        postInput.value = allowPosting ? 'TRUE' : 'FALSE';
        form.appendChild(postInput);

        const commentInput = document.createElement('input');
        commentInput.type = 'hidden';
        commentInput.name = 'allowCommenting';
        commentInput.value = allowCommenting ? 'TRUE' : 'FALSE';
        form.appendChild(commentInput);
        
        form.submit();
        
        const modal = document.getElementById('class-settings-modal');
        if (modal) modal.style.display = 'none'; // Safely close modal after submit
        
        // Clean up
        form.removeChild(postInput);
        form.removeChild(commentInput);
    }

    /**
     * Shows the delete confirmation dialog.
     */
    function showDeleteConfirmation(className, classCode) {
        const modal = document.getElementById('confirm-dialog-modal');
        if (!modal) return; // Null check
        
        document.getElementById('confirm-dialog-title').innerText = `Confirm Deletion`;
        document.getElementById('confirm-dialog-body').innerHTML = `Are you sure you want to delete the class <strong>${className}</strong> (Code: ${classCode})? This action cannot be undone.`;
        // The HTML uses 'confirm-delete-btn' for delete action
        document.getElementById('confirm-delete-btn').onclick = () => submitDeleteClass(classCode); 
        modal.style.display = 'flex';
    }

    /**
     * Submits class deletion to Apps Script.
     */
    function submitDeleteClass(classCode) {
        const confirmModal = document.getElementById('confirm-dialog-modal');
        if (confirmModal) confirmModal.style.display = 'none'; // Safely close confirm modal
        
        // Temporarily create the form and submit it
        const tempForm = document.createElement('form');
        tempForm.target = 'hidden-iframe';
        tempForm.method = 'POST';
        tempForm.action = SCRIPT_URL;
        tempForm.style.display = 'none';
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'deleteClass';
        tempForm.appendChild(actionInput);
        
        const codeInput = document.createElement('input');
        codeInput.type = 'hidden';
        codeInput.name = 'classCode';
        codeInput.value = classCode;
        tempForm.appendChild(codeInput);
        
        document.body.appendChild(tempForm);
        tempForm.submit();
        document.body.removeChild(tempForm);
    }
    
    /**
     * Placeholder: Students load their assignments here.
     */
    function loadAssignments(studentId) {
        const assignmentList = document.getElementById('assignment-list');
        if (!assignmentList) return;
        
        // --- HARDCODED ASSIGNMENT DATA (REPLACE LATER) ---
        const assignments = [
            { name: "Unit 3 Test Review", type: "Test", due: "2025-10-15", progress: "80%" },
            { name: "Algebra I Quiz 5", type: "Quiz", due: "2025-10-12", progress: "New" },
        ];
        
        assignmentList.innerHTML = assignments.map(a => `
            <div class="assignment-item">
                <span class="assignment-name">${a.name} (${a.type})</span>
                <span class="assignment-progress">${a.progress}</span>
                <span class="assignment-due">Due: ${a.due}</span>
            </div>
        `).join('');
    }

    // ======================================================================
    // 4. CLASS DASHBOARD LOGIC (BASE64 INTEGRATION)
    // ======================================================================
    
    /**
     * Handles file selection, enforces the 30KB limit, and encodes to Base64.
     */
    function handleFileUploadSelection(input) {
        const infoSpan = document.getElementById('file-selection-info');
        const mediaDataUriInput = document.getElementById('post-media-data-uri');
        const mediaTypeInput = document.getElementById('post-media-type');

        if (input.files.length === 0) {
            if (infoSpan) infoSpan.innerText = '';
            if (mediaDataUriInput) mediaDataUriInput.value = '';
            if (mediaTypeInput) mediaTypeInput.value = 'text';
            return;
        }

        const file = input.files[0];

        // 1. Enforce 30KB Size Limit
        if (file.size > MAX_FILE_SIZE_BYTES) {
            if (infoSpan) {
                infoSpan.style.color = 'var(--danger-color)';
                infoSpan.innerText = `Error: File size (${(file.size / 1024).toFixed(1)} KB) exceeds the 30KB limit.`;
            }
            input.value = ''; // Clear file input
            if (mediaDataUriInput) mediaDataUriInput.value = '';
            if (mediaTypeInput) mediaTypeInput.value = 'text';
            return;
        }

        // 2. Read and Encode the file
        const reader = new FileReader();
        reader.onload = function(e) {
            if (mediaDataUriInput) mediaDataUriInput.value = e.target.result; // The data: URI (Base64 string)
            
            // Set media type based on MIME type for rendering logic
            let mediaType = 'file';
            if (file.type.includes('image')) {
                mediaType = 'image';
            } else if (file.type.includes('pdf')) {
                mediaType = 'pdf';
            }
            
            if (mediaTypeInput) mediaTypeInput.value = mediaType;

            if (infoSpan) {
                infoSpan.style.color = 'var(--success-color)';
                infoSpan.innerText = `File ready: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            }
        };
        
        reader.readAsDataURL(file); // Critical: Read the file as a Data URL (Base64)
    }

    /**
     * Renders a single post item using real data, handling Base64 display.
     */
    function renderPostItem(post) {
        function timeSince(dateString) {
            const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + " years ago";
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + " months ago";
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + " days ago";
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + " hours ago";
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + " minutes ago";
            return "Just now";
        }

        let mediaHTML = '';
        const mediaDataURI = post.mediaDataURI; 

        if (mediaDataURI) {
            if (post.mediaType === 'image') {
                // Display the Base64 image directly
                mediaHTML = `<img src="${mediaDataURI}" alt="Posted image" class="posted-media">`;
            } else if (post.mediaType === 'pdf' || post.mediaType === 'file') {
                // Provide a download link for the Base64 file
                const fileExtension = post.mediaType === 'pdf' ? 'pdf' : post.mediaType.split('/')[1] || 'dat';
                const fileName = `${post.classCode}_attachment.${fileExtension}`;

                mediaHTML = `
                    <div class="file-attachment">
                        <a href="${mediaDataURI}" download="${fileName}" style="text-decoration: none; display: flex; align-items: center; gap: 5px; color: var(--accent-color); font-weight: bold;">
                            <span class="material-icons">${post.mediaType === 'pdf' ? 'picture_as_pdf' : 'attach_file'}</span> 
                            Download Attachment (${post.mediaType.toUpperCase()})
                        </a>
                        <small style="display:block; margin-top:5px; color:#888;">File data is stored directly in the sheet.</small>
                    </div>`;
            }
        }
        
        const initials = post.authorName.split(' ').map(n => n[0]).join('').toUpperCase();
        
        return `
            <div class="post-item" data-author-id="${post.authorId}">
                <div class="post-header">
                    <div class="profile-pic">${initials}</div>
                    <div class="post-meta">
                        <span class="author-name">${post.authorName}</span>
                        <span class="post-id">(ID: ${post.authorId})</span>
                        <span class="post-time">${timeSince(post.timestamp)}</span>
                    </div>
                    <button class="report-button">Report</button>
                </div>
                <div class="post-body">
                    <p>${post.content}</p>
                    ${mediaHTML}
                </div>
                <div class="post-actions">
                    <button class="reply-button">Reply</button>
                </div>
            </div>
        `;
    }

    /**
     * Fetches and renders all posts for a given class code using JSONP.
     */
    async function loadClassPosts(classCode) {
        const postsSection = document.getElementById('previous-posts-section');
        if (!postsSection) return;

        postsSection.innerHTML = '<div class="loading-message">Loading class posts...</div>';

        try {
            const result = await fetchJsonp('loadPosts', { classCode: classCode });
            
            if (result.status === 'success' && result.posts && result.posts.length > 0) {
                postsSection.innerHTML = result.posts.map(renderPostItem).join('');
            } else {
                postsSection.innerHTML = '<div class="empty-state-message">Be the first to post in this class!</div>';
            }
        } catch (error) {
            postsSection.innerHTML = `<div class="info-message" style="background-color:var(--danger-color); color:white;">Error loading posts: ${error.message}</div>`;
            console.error("Failed to load posts:", error);
        }
    }
    
    /**
     * Re-attaches the listener for the post form submit and clears inputs.
     */
    function attachPostFormListener(classCode) {
        const form = document.getElementById('create-post-form');
        if (form) {
            form.onsubmit = function() {
                // Client-side check before submission
                const content = document.getElementById('post-text-input').value.trim();
                const media = document.getElementById('post-media-data-uri').value;
                if (!content && !media) {
                    showInfoDialog('Warning', 'Please enter content or select a file.', 'info');
                    return false; 
                }
                return true; 
            };

            const originalHandlePostResponse = window.handlePostResponse;
            window.handlePostResponse = (result) => {
                originalHandlePostResponse(result); 
                if (result.status === 'success' && result.message === 'Post created successfully.') {
                    // Clear all post inputs after success
                    form.reset();
                    const mediaDataUriInput = document.getElementById('post-media-data-uri');
                    const mediaTypeInput = document.getElementById('post-media-type');
                    const fileUploadInput = document.getElementById('post-file-upload');
                    const infoSpan = document.getElementById('file-selection-info');

                    if (mediaDataUriInput) mediaDataUriInput.value = '';
                    if (mediaTypeInput) mediaTypeInput.value = 'text';
                    if (fileUploadInput) fileUploadInput.value = ''; // Clear file input element
                    if (infoSpan) infoSpan.innerText = '';
                    
                    // Reload posts after a short delay
                    setTimeout(() => loadClassPosts(classCode), 1000); 
                }
            };
        }
    }

    /**
     * Renders the class-specific dashboard view (the class feed).
     */
    function openClassDashboard(classCode, className) {
        currentClassCode = classCode; 
        currentClassName = className; 
        
        const appHeader = document.getElementById('app-header');
        const dashboardContainer = document.getElementById('dashboard-container');

        if (!appHeader || !dashboardContainer) return; // Basic null check

        // --- Header for Class Dashboard ---
        appHeader.innerHTML = `
            <div class="header-left">
                <button id="back-to-main-dashboard-btn" class="nav-button">
                    <span class="material-icons">arrow_back</span>
                    Back to Dashboard
                </button>
            </div>
            <div class="header-center">
                <h1 class="app-title">${className}</h1>
            </div>
            <div class="header-right">
                <button id="logout-btn" class="nav-button">
                    <span class="material-icons">logout</span> Logout
                </button>
            </div>`;

        // --- Main Content for Class Dashboard (NEW POST FORM) ---
        dashboardContainer.innerHTML = `
            <div class="class-view-container">
                <div class="class-banner" style="background-image: url('https://via.placeholder.com/1200x200/4CAF50/FFFFFF?text=Class+Banner+Image');">
                    <div class="class-banner-content">
                        ${(userRole === 'teacher') ? 
                            // Note: openClassSettingsModal is now a global function
                            `<span class="class-banner-settings material-icons" onclick="openClassSettingsModal('${classCode}', '${className}', true, true)">settings</span>` 
                            : ''
                        }
                        <div class="class-info">
                            <h2>${className}</h2>
                            <p>Class Code: ${classCode}</p> 
                        </div>
                    </div>
                </div>
                
                <form id="create-post-form" target="hidden-iframe" method="POST" action="${SCRIPT_URL}">
                    <input type="hidden" name="action" value="createPost">
                    <input type="hidden" name="classCode" value="${classCode}">
                    <input type="hidden" name="authorId" id="post-author-id" value="${currentUserId}">
                    <input type="hidden" name="authorName" id="post-author-name" value="${userFullName}">
                    
                    <input type="hidden" name="mediaDataURI" id="post-media-data-uri" value="">
                    <input type="hidden" name="mediaType" id="post-media-type" value="text">

                    <div class="post-creation-area">
                        <div class="post-input-row">
                            <input type="text" id="post-text-input" name="content" placeholder="Post Something to your class" required>
                            <button type="submit" id="submit-post-btn" class="primary-button">Submit</button>
                        </div>
                        <div class="post-options">
                            <input type="file" id="post-file-upload" style="display:none;" 
                                accept="image/*,.pdf,.txt" 
                                onchange="handleFileUploadSelection(this)">

                            <button type="button" class="option-button" onclick="document.getElementById('post-file-upload').click();">
                                <span class="material-icons">perm_media</span> Add multimedia (Max 30KB)
                            </button>
                            
                            <span id="file-selection-info" style="font-size:0.9em; color:var(--success-color); margin-left:10px;"></span>

                            ${(userRole === 'teacher') ? 
                                `<button type="button" class="option-button"><span class="material-icons">assignment</span> Create assignment</button>` : 
                                `<button type="button" class="option-button"><span class="material-icons">send</span> Send to a different class</button>`
                            }
                        </div>
                    </div>
                </form>

                <div class="previous-posts-section" id="previous-posts-section">
                    </div>
            </div>
        `;

        // Attach listeners
        document.getElementById('back-to-main-dashboard-btn').addEventListener('click', () => {
            renderDashboard(userRole); 
        });
        document.getElementById('logout-btn').addEventListener('click', logout);
        
        // Load posts and attach the post form listener
        loadClassPosts(classCode);
        attachPostFormListener(classCode);
    }
    
    // ======================================================================
    // 5. RENDERING & INITIALIZATION
    // ======================================================================

    /**
     * Renders a single class card for the teacher dashboard.
     */
    function renderClassCard(classData, role) {
        const settingsBtn = (role === 'teacher') 
            ? `<button class="settings-button" onclick="openClassSettingsModal('${classData.code}', '${classData.name}', ${classData.allowPosting === 'TRUE'}, ${classData.allowCommenting === 'TRUE'})">
                <span class="material-icons">settings</span>
               </button>`
            : '';
            
        return `
            <div class="class-card" onclick="openClassDashboard('${classData.code}', '${classData.name}')">
                <div class="card-header">
                    <h3>${classData.name}</h3>
                    ${settingsBtn}
                </div>
                <div class="card-meta">Teacher: ${classData.teacher}</div>
                <div class="card-meta">Code: ${classData.code}</div>
                <div class="card-status-toggles">
                    <span class="status-label">Posting: <span class="status-${classData.allowPosting === 'TRUE' ? 'on' : 'off'}">${classData.allowPosting}</span></span>
                    <span class="status-label">Commenting: <span class="status-${classData.allowCommenting === 'TRUE' ? 'on' : 'off'}">${classData.allowCommenting}</span></span>
                </div>
            </div>
        `;
    }

    /**
     * Loads class data for the teacher from the Google Sheet (via JSONP).
     */
    async function loadTeacherData(teacherId) {
        const classGrid = document.querySelector('.class-grid');
        if (!classGrid) return;
        
        // Clear all except the Create Class card
        classGrid.querySelectorAll('.class-card:not(.create-class-card)').forEach(card => card.remove());

        try {
            const result = await fetchJsonp('loadClasses', { teacher: userFullName }); // Use userFullName as the identifier
            
            if (result.status === 'success' && result.classes.length > 0) {
                // Ensure the create card is always last
                const createCard = document.getElementById('create-class-card');
                
                result.classes.forEach(classData => {
                    const newCard = document.createRange().createContextualFragment(renderClassCard(classData, 'teacher'));
                    if (createCard) {
                        classGrid.insertBefore(newCard, createCard);
                    } else {
                        classGrid.appendChild(newCard);
                    }
                });
            }
        } catch (error) {
            console.error("Failed to load teacher data:", error);
        }
    }

    /**
     * Renders the main dashboard structure based on the user's role.
     */
    async function renderDashboard(role) {
        let content = '';
        let header = '';

        const dashboardContainer = document.getElementById('dashboard-container');
        const appHeader = document.getElementById('app-header');

        userRole = role; 
        
        if (!dashboardContainer || !appHeader) return; // Check main elements

        // --- Teacher View ---
        if (role === 'teacher') {
            header = `
                <div class="header-left">
                    <button class="nav-button" onclick="document.getElementById('role-switch-modal').style.display='flex'">
                        <span class="material-icons">switch_account</span> Switch to Student
                    </button>
                </div>
                <div class="header-center">
                    <h1 class="app-title">CoolMathTime: Teacher Dashboard</h1>
                </div>
                <div class="header-right">
                    <button id="logout-btn" class="nav-button">
                        <span class="material-icons">logout</span> Logout
                    </button>
                </div>`;
            
            content = `
                <h2 class="section-title">My Classes</h2>
                <div class="class-grid">
                    <div class="class-card create-class-card" id="create-class-card" onclick="document.getElementById('class-management-modal').style.display='flex'">
                        <span class="material-icons icon">add_circle_outline</span>
                        <h3>Create New Class</h3>
                        <p>Start a new learning group</p>
                    </div>
                </div>`;
            
        // --- Student View ---
        } else if (role === 'student') {
            
            const count = await getStudentEnrollmentCount(); // AWAIT THE REAL COUNT
            const enrollmentText = count === 1 
                ? `You are enrolled in 1 course.` 
                : `You are enrolled in ${count} courses.`;
            
            header = `
                <div class="header-left">
                    <button class="nav-button" onclick="document.getElementById('role-switch-modal').style.display='flex'">
                        <span class="material-icons">switch_account</span> Switch to Teacher
                    </button>
                </div>
                <div class="header-center">
                    <h1 class="app-title">CoolMathTime: Learning Dashboard</h1>
                </div>
                <div class="header-right">
                    <button id="logout-btn" class="nav-button">
                        <span class="material-icons">logout</span> Logout
                    </button>
                </div>`;
                
            content = `
                <h2 class="section-title">📝 My Assignments & Recommended Practice</h2>
                <div id="assignment-list" class="assignment-list">Loading assignments...</div>

                <h2 class="section-title">📊 Progress & Mastery</h2>
                <div class="feature-grid">
                    <div class="feature-card" onclick="document.getElementById('join-class-modal').style.display='flex'">
                        <div class="card-header"><span class="material-icons icon">person_add</span> Join a Class</div>
                        <div class="card-meta">Enter a code to enroll in a new course.</div>
                    </div>
                    <div class="feature-card" id="review-enrollment-card">
                        <div class="card-header"><span class="material-icons icon">push_pin</span> Review Course Enrollment</div>
                        <div class="card-meta">${enrollmentText}</div> 
                    </div>
                </div>`;
        }

        // Render content
        appHeader.innerHTML = header;
        dashboardContainer.innerHTML = content;
        
        attachDashboardListeners(role);

        if (role === 'teacher') {
            loadTeacherData(userFullName); // Load classes for the teacher's name
        } else if (role === 'student') {
            loadAssignments(currentUserId); 
        }
    }

    /**
     * Placeholder: Switches the user's role in the UI (not stored in sheet yet).
     */
    function switchRole(role) {
        const modal = document.getElementById('role-switch-modal');
        if (modal) modal.style.display = 'none'; // Safely close modal
        renderDashboard(role);
    }
    
    /**
     * Loads the user role (Hardcoded for now, will be implemented with Sheets later).
     */
    function loadUserRole(userId) {
        // --- HARDCODED ROLE LOGIC (REPLACE LATER) ---
        // Use a placeholder name based on the UID for posting until real name lookup is implemented
        userFullName = `User_${userId.substring(0, 5)}`; 
        
        // Example logic: if the UID starts with 'T', assume teacher.
        const role = userId.startsWith('T') ? 'teacher' : 'student';

        renderDashboard(role);
    }

    /**
     * Placeholder: Logs the user out.
     */
    function logout() {
        auth.signOut().then(() => {
            window.location.replace('index.html');
        }).catch((error) => {
            console.error("Logout failed:", error);
        });
    }

    /**
     * Attaches event listeners after the dashboard content is rendered.
     */
    function attachDashboardListeners(role) {
        const createClassForm = document.getElementById('create-class-form');
        const submitCreateClassBtn = createClassForm ? createClassForm.querySelector('button[type="submit"]') : null;
        const logoutBtn = document.getElementById('logout-btn');
        
        if (createClassForm) createClassForm.action = SCRIPT_URL;
        if (logoutBtn) logoutBtn.addEventListener('click', logout);
        if (submitCreateClassBtn) submitCreateClassBtn.onclick = createClass;

        // --- Get all modal elements for safe handling ---
        const classSettingsModal = document.getElementById('class-settings-modal');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
        const deleteClassBtn = document.getElementById('delete-class-btn');
        
        const infoDialogModal = document.getElementById('info-dialog-modal');
        const roleSwitchModal = document.getElementById('role-switch-modal');
        const classManagementModal = document.getElementById('class-management-modal');
        const confirmDialogModal = document.getElementById('confirm-dialog-modal');
        const joinClassModal = document.getElementById('join-class-modal');


        // Handlers for class-settings-modal (only if modal exists)
        if (classSettingsModal) {
            if (saveSettingsBtn) {
                saveSettingsBtn.onclick = () => {
                    const code = document.getElementById('settings-class-code').value;
                    const name = document.getElementById('settings-class-name').value;
                    // Read checked state directly from the checkbox
                    const allowPosting = document.getElementById('settings-allow-posting').checked;
                    const allowCommenting = document.getElementById('settings-allow-commenting').checked;
                    saveClassSettings(code, name, allowPosting, allowCommenting);
                };
            }
            
            if (cancelSettingsBtn) {
                cancelSettingsBtn.onclick = () => classSettingsModal.style.display = 'none';
            }
    
            if (deleteClassBtn) {
                deleteClassBtn.onclick = () => {
                    const classCode = deleteClassBtn.dataset.classCode;
                    const className = deleteClassBtn.dataset.className;
                    showDeleteConfirmation(className, classCode);
                };
            }
        }
        
        // Close modal if user clicks outside of it
        // This is the CRITICAL block to fix the global scope error:
        window.onclick = function(event) {
            // Create a list of all possible modal elements that can be closed by clicking the backdrop
            const closableModals = [
                classSettingsModal,
                infoDialogModal,
                roleSwitchModal,
                classManagementModal,
                confirmDialogModal,
                joinClassModal
            ];

            // Iterate through the list and check if the clicked target matches a modal backdrop
            for (const modal of closableModals) {
                // IMPORTANT: The modal variable might be null if the HTML element doesn't exist.
                // We use a null check (if (modal)) AND ensure the event target is the modal itself.
                if (modal && event.target === modal) {
                    modal.style.display = "none";
                }
            }
        }
    }

    // --- CHECK AUTH STATUS AND REDIRECT IF NOT LOGGED IN ---
    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.replace('index.html');
        } else {
            currentUserId = user.uid;
            // This call triggers the entire dashboard rendering process
            loadUserRole(user.uid); 
        }
    });
</script>
</body>
</html>
