<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HouseLearning Notification Sender</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { font-size: 20px; }
    input, textarea { width: 100%; padding: 8px; margin: 6px 0; font-size: 14px; }
    button { padding: 8px 12px; margin: 6px 0; font-size: 14px; cursor: pointer; }
    .notif { border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: #fff; border-radius: 6px; }
    .unread { border-left: 4px solid #ff3b30; }
  </style>
</head>
<body>
  <h1>Send Notification to HouseLearning</h1>
  <button id="signin">Sign in with Google</button>
  <button id="signout">Sign out</button>
  <p id="user-status">Not signed in</p>

  <hr />

  <label>Recipient UID</label>
  <input type="text" id="recipientUid" placeholder="Enter recipient UID" />

  <label>Title</label>
  <input type="text" id="title" placeholder="Notification title" />

  <label>Body</label>
  <textarea id="body" placeholder="Notification body"></textarea>

  <label>Optional URL</label>
  <input type="text" id="url" placeholder="https://example.com" />

  <label>Mark as Read</label>
  <select id="read">
    <option value="false">Unread</option>
    <option value="true">Read</option>
  </select>

  <button id="send">Send Notification</button>
  <p id="status"></p>

  <hr />
  <h2>Live Notifications</h2>
  <div id="notifications"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDoXSwni65CuY1_32ZE8B1nwfQO_3VNpTw",
      authDomain: "contract-center-llc-10.firebaseapp.com",
      projectId: "contract-center-llc-10",
      storageBucket: "contract-center-llc-10.firebasestorage.app",
      messagingSenderId: "323221512767",
      appId: "1:323221512767:web:6421260f875997dbf64e8a",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const signinBtn = document.getElementById('signin');
    const signoutBtn = document.getElementById('signout');
    const userStatus = document.getElementById('user-status');
    const sendBtn = document.getElementById('send');
    const status = document.getElementById('status');
    const notificationsDiv = document.getElementById('notifications');

    let currentUser = null;
    let unsubscribe = null;

    signinBtn.onclick = async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch (e) {
        alert("Sign-in failed: " + e.message);
      }
    };

    signoutBtn.onclick = async () => {
      if (unsubscribe) unsubscribe();
      await auth.signOut();
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        userStatus.textContent = `Signed in as ${user.displayName || user.email}`;
        listenToNotifications(user.uid);
      } else {
        currentUser = null;
        userStatus.textContent = "Not signed in";
        notificationsDiv.innerHTML = "";
      }
    });

    function listenToNotifications(uid) {
      if (unsubscribe) unsubscribe();
      unsubscribe = db.collection("notifications")
        .where("recipientUid", "==", uid)
        .orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
          notificationsDiv.innerHTML = "";
          if (snapshot.empty) {
            notificationsDiv.innerHTML = "<p>No notifications</p>";
            return;
          }
          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "notif" + (data.read ? "" : " unread");
            div.innerHTML = `
              <strong>${data.title}</strong><br/>
              <p>${data.body}</p>
              <small>${data.timestamp?.toDate?.().toLocaleString() || ""}</small><br/>
              ${data.url ? `<a href="${data.url}" target="_blank">Open Link</a>` : ""}
            `;
            notificationsDiv.appendChild(div);
          });
        });
    }

    sendBtn.onclick = async () => {
      if (!currentUser) {
        alert("Sign in first");
        return;
      }

      const recipientUid = document.getElementById('recipientUid').value.trim();
      const title = document.getElementById('title').value.trim();
      const body = document.getElementById('body').value.trim();
      const url = document.getElementById('url').value.trim();
      const read = document.getElementById('read').value === "true";

      if (!recipientUid || !title || !body) {
        status.textContent = "Recipient UID, title, and body are required.";
        return;
      }

      try {
        await db.collection("notifications").add({
          recipientUid,
          title,
          body,
          url: url || null,
          read,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        status.textContent = "Notification sent!";
      } catch (e) {
        status.textContent = "Error sending: " + e.message;
      }
    };
  </script>
</body>
</html>
