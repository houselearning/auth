<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HouseLearning Notification Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    :root {
      --primary: #4285f4;
      --border: #dadce0;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }
    .wrap {
      max-width: 720px;
      margin: 40px auto;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      padding: 24px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 22px;
    }
    .sub {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .row {
      display: grid;
      gap: 12px;
      margin-bottom: 16px;
      grid-template-columns: 1fr 1fr;
    }
    .row.full { grid-template-columns: 1fr; }
    label {
      font-size: 13px;
      color: #333;
      margin-bottom: 6px;
      display: block;
    }
    input[type="text"], input[type="url"], textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
    }
    textarea { min-height: 100px; resize: vertical; }
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    button {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .primary {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .primary:hover { filter: brightness(0.95); }
    .muted {
      color: #555;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
      color: #444;
    }
    .ok { color: #0a7c2f; }
    .err { color: #b00020; }
    .card {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 16px;
      background: #fafafa;
    }
    .small {
      font-size: 12px;
      color: #777;
    }
    .grid-3 {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(3, 1fr);
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: #f5f7fb;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Send notifications to HouseLearning</h1>
    <div class="sub">Sign in, enter a recipient UID, and send a real-time notification to the platform.</div>

    <div class="card" id="auth-card">
      <div class="row full">
        <div>
          <label>Authentication</label>
          <div class="actions">
            <button id="google-signin" class="primary">Sign in with Google</button>
            <button id="signout" class="muted">Sign out</button>
          </div>
          <div id="auth-status" class="status">Not signed in.</div>
        </div>
      </div>
      <div class="small">Signed-in users must have Firestore rules permitting writes to the <span class="mono">notifications</span> collection.</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="row full">
        <div>
          <label>Your UID (auto):</label>
          <div id="current-uid" class="mono">—</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Recipient UID</label>
          <input type="text" id="recipient-uid" placeholder="e.g., aFirebaseAuthUidString" />
        </div>
        <div>
          <label>Optional URL</label>
          <input type="url" id="notif-url" placeholder="https://example.com/something" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Title</label>
          <input type="text" id="notif-title" placeholder="Notification title" />
        </div>
        <div>
          <label>Mark as read (default false)</label>
          <div class="actions">
            <button id="set-unread" class="muted">Set unread</button>
            <button id="set-read" class="muted">Set read</button>
          </div>
          <div class="small">Current: <span id="read-state" class="mono">false</span></div>
        </div>
      </div>

      <div class="row full">
        <div>
          <label>Body</label>
          <textarea id="notif-body" placeholder="Message body"></textarea>
        </div>
      </div>

      <div class="actions">
        <button id="send-notif" class="primary">Send notification</button>
        <button id="send-self" class="muted">Send to myself</button>
      </div>

      <div id="send-status" class="status">—</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="row full">
        <div>
          <label>Most recent sent (this session)</label>
          <div id="last-doc" class="mono">—</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config from your platform
    const firebaseConfig = {
      apiKey: "AIzaSyDoXSwni65CuY1_32ZE8B1nwfQO_3VNpTw",
      authDomain: "contract-center-llc-10.firebaseapp.com",
      projectId: "contract-center-llc-10",
      storageBucket: "contract-center-llc-10.firebasestorage.app",
      messagingSenderId: "323221512767",
      appId: "1:323221512767:web:6421260f875997dbf64e8a",
    };

    // Initialize
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI refs
    const googleBtn = document.getElementById('google-signin');
    const signOutBtn = document.getElementById('signout');
    const authStatus = document.getElementById('auth-status');
    const currentUidEl = document.getElementById('current-uid');

    const recipientUidEl = document.getElementById('recipient-uid');
    const urlEl = document.getElementById('notif-url');
    const titleEl = document.getElementById('notif-title');
    const bodyEl = document.getElementById('notif-body');
    const sendBtn = document.getElementById('send-notif');
    const sendSelfBtn = document.getElementById('send-self');
    const sendStatus = document.getElementById('send-status');
    const lastDocEl = document.getElementById('last-doc');

    const setUnreadBtn = document.getElementById('set-unread');
    const setReadBtn = document.getElementById('set-read');
    const readStateEl = document.getElementById('read-state');

    let markRead = false;

    // Auth handlers
    googleBtn.addEventListener('click', async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch (e) {
        authStatus.textContent = `Sign-in failed: ${e.message}`;
        authStatus.className = 'status err';
      }
    });

    signOutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
      } catch (e) {
        authStatus.textContent = `Sign-out failed: ${e.message}`;
        authStatus.className = 'status err';
      }
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        authStatus.textContent = `Signed in as ${user.displayName || user.email || user.uid}`;
        authStatus.className = 'status ok';
        currentUidEl.textContent = user.uid;
      } else {
        authStatus.textContent = 'Not signed in.';
        authStatus.className = 'status';
        currentUidEl.textContent = '—';
      }
    });

    // Read state toggles
    setUnreadBtn.addEventListener('click', () => {
      markRead = false;
      readStateEl.textContent = 'false';
    });
    setReadBtn.addEventListener('click', () => {
      markRead = true;
      readStateEl.textContent = 'true';
    });

    // Helpers
    function assertSignedIn() {
      const u = auth.currentUser;
      if (!u) throw new Error('You must sign in before sending.');
      return u;
    }
    function trimOrNull(v) {
      const s = (v || '').trim();
      return s.length ? s : null;
    }

    // Send to myself convenience
    sendSelfBtn.addEventListener('click', () => {
      const u = auth.currentUser;
      if (!u) {
        sendStatus.textContent = 'You must sign in first.';
        sendStatus.className = 'status err';
        return;
      }
      recipientUidEl.value = u.uid;
      sendStatus.textContent = 'Recipient set to your UID.';
      sendStatus.className = 'status';
    });

    // Send notification
    sendBtn.addEventListener('click', async () => {
      sendStatus.textContent = 'Sending...';
      sendStatus.className = 'status';

      try {
        const sender = assertSignedIn();
        const recipientUid = trimOrNull(recipientUidEl.value);
        const title = trimOrNull(titleEl.value);
        const body = trimOrNull(bodyEl.value);
        const url = trimOrNull(urlEl.value);

        if (!recipientUid) throw new Error('Recipient UID is required.');
        if (!title) throw new Error('Title is required.');
        if (!body) throw new Error('Body is required.');

        // Document shape aligned with your listener
        const doc = {
          recipientUid,
          title,
          body,
          url: url || null,
          read: !!markRead,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          // Optional extras you might want:
          // createdByUid: sender.uid,
          // createdByName: sender.displayName || sender.email || null
        };

        const ref = await db.collection('notifications').add(doc);
        const snapshot = await ref.get();

        // Resolve server timestamp for display (may be null until on server)
        const data = snapshot.data() || {};
        const ts = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toISOString() : '(server timestamp pending)';

        lastDocEl.textContent = JSON.stringify({ id: ref.id, ...doc, timestamp: ts }, null, 2);
        sendStatus.textContent = 'Notification sent.';
        sendStatus.className = 'status ok';

        // Optional: clear fields after send
        // titleEl.value = '';
        // bodyEl.value = '';
        // urlEl.value = '';
        // markRead = false; readStateEl.textContent = 'false';
      } catch (e) {
        sendStatus.textContent = `Send failed: ${e.message}`;
        sendStatus.className = 'status err';
      }
    });
  </script>
</body>
</html>
